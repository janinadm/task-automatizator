import"./CfzA8m0i.js";import{a0 as x,y as o,B as T}from"./DEKUsMT3.js";import{u as _}from"./CLFJ9VCG.js";import{u as $}from"./B5DQxwAU.js";const m={DEFAULT_PAGE_SIZE:20},w=x("tickets",()=>{const c=o([]),l=o(null),a=o(null),n=o({page:1,pageSize:m.DEFAULT_PAGE_SIZE,sortBy:"createdAt",sortOrder:"desc"}),r=o(!1),p=o(!1),d=o(!1),e=o(null),g=T(()=>l.value?.totalPages??1),v=T(()=>l.value?.hasNextPage??!1),y=T(()=>l.value?.hasPrevPage??!1),P=T(()=>n.value.page??1);async function k(s){r.value=!0,e.value=null,s&&(n.value={...n.value,...s});try{const i=Object.entries(n.value).filter(([,t])=>t!=null&&t!=="").reduce((t,[h,u])=>({...t,[h]:u}),{}),f=await $fetch("/api/tickets",{query:i});c.value=f.data,l.value=f.meta}catch(i){e.value=i?.data?.message??"Failed to load tickets",c.value=[]}finally{r.value=!1}}async function A(s){p.value=!0,e.value=null;try{const i=await $fetch(`/api/tickets/${s}`);a.value=i.data}catch(i){e.value=i?.data?.message??"Failed to load ticket",a.value=null}finally{p.value=!1}}async function b(s,i){d.value=!0,e.value=null;const f=a.value,t=c.value.findIndex(u=>u.id===s),h=t>=0?{...c.value[t]}:null;a.value?.id===s&&(a.value={...a.value,...i}),t>=0&&(c.value[t]={...c.value[t],...i});try{const u=await $fetch(`/api/tickets/${s}`,{method:"PATCH",body:i});return a.value?.id===s&&(a.value={...a.value,...u.data}),t>=0&&(c.value[t]={...c.value[t],...u.data}),u.data}catch(u){throw f&&(a.value=f),t>=0&&h&&(c.value[t]=h),e.value=u?.data?.message??"Failed to update ticket",u}finally{d.value=!1}}function I(s,i){n.value={...n.value,[s]:i,page:1},k()}function E(){n.value={page:1,pageSize:m.DEFAULT_PAGE_SIZE,sortBy:"createdAt",sortOrder:"desc"},k()}function S(s){n.value={...n.value,page:s},k()}return{tickets:c,meta:l,currentTicket:a,filters:n,isLoadingList:r,isLoadingDetail:p,isUpdating:d,error:e,totalPages:g,hasNextPage:v,hasPrevPage:y,currentPage:P,fetchTickets:k,fetchTicket:A,updateTicket:b,setFilter:I,resetFilters:E,goToPage:S}}),O=()=>{const c=_(),l=w(),a=$();function n(r){return c.channel(`org-tickets:${r}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"tickets",filter:`orgId=eq.${r}`},async()=>{a.info("ðŸŽ« New ticket received"),await l.fetchTickets()}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"tickets",filter:`orgId=eq.${r}`},d=>{const e=d.new,g=l.tickets.findIndex(v=>v.id===e.id);if(g>=0){const v=l.tickets[g];v&&Object.assign(v,{status:e.status,priority:e.priority,assignedToId:e.assignedToId,updatedAt:e.updatedAt,sentiment:e.sentiment,category:e.category})}l.currentTicket?.id===e.id&&l.fetchTicket(e.id)}).subscribe(d=>{})}return{subscribe:n}};export{O as a,w as u};
